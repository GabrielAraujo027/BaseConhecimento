<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Listagem de Chamados</title>
<style>
/* Reset básico */
* { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', sans-serif; }

/* Layout principal */
.dashboard { display: flex; height: 100vh; }

/* Sidebar */
.sidebar {
  width: 240px;
  padding: 20px;
  background: #3a1c71;
  color: #fff;
  display: flex;
  flex-direction: column;
  gap: 30px;
}
.sidebar .logo { font-size: 28px; font-weight: bold; text-align: center; color: #ff7e29; }
.sidebar nav a {
  display: block;
  color: #fff;
  margin-bottom: 12px;
  padding: 10px 15px;
  border-radius: 8px;
  text-decoration: none;
  transition: background 0.3s;
}
.sidebar nav a:hover { background: #2a1152; }

/* Status panel */
.status-panel {
  background: #ff7e29;
  border-radius: 8px;
  padding: 15px;
  font-weight: bold;
  color: #fff;
}
.status-panel h3 { margin-bottom: 10px; text-align:center; }
.status-panel p { margin: 4px 0; }

/* Main */
.main-content {
  flex:1;
  display:flex;
  flex-direction: column;
  padding: 20px;
  background: #f5f5f7;
  min-height:0;
}

/* Accordion Filtros */
#accordion-filtros {
  background: #3a1c71;
  color: #fff;
  cursor: pointer;
  padding: 12px 20px;
  border-radius: 8px;
  text-align: left;
  font-size: 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  border: none;
}
#accordion-filtros:after { content: '\002B'; font-weight: bold; }
#accordion-filtros.active:after { content: "\2212"; }
.filtros-panel {
  display: none;
  flex-wrap: wrap;
  gap: 10px;
  padding: 15px;
  background: #fff;
  border-radius: 8px;
  margin-bottom: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.filtros-panel input, .filtros-panel select {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  flex: 1 1 150px;
}

/* Table */
.table-section { display: flex; gap: 20px; flex:1; min-height:0; }
.table-container { flex:1; display:flex; flex-direction:column; overflow-y:auto; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); min-height:0; }
table { width:100%; border-collapse: collapse; flex:1; }
thead th {
  position: sticky; top:0;
  background: #3a1c71;
  color:#fff;
  padding:12px;
}
tbody td { padding:12px; border-bottom:1px solid #eee; }
tbody tr:hover { background:#f0e8ff; cursor:pointer; }

/* Status colors */
.status.pendente { color: #ff7e29; font-weight: bold; }
.status.em-andamento { color: #3498db; font-weight: bold; }
.status.concluído { color: #2ecc71; font-weight: bold; }
.status.cancelado { color: #e74c3c; font-weight: bold; }

/* Detalhes do chamado */
.chamado-detalhes {
  width: 320px;
  background: #fff;
  padding: 15px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  display:flex; flex-direction:column; gap:15px;
}
.chamado-detalhes h2 { color: #3a1c71; margin-bottom:10px; text-align:center; }
.chamado-detalhes h3 { margin-bottom:5px; }
.chamado-detalhes .acoes {
  display:flex;
  justify-content: space-between;
  gap:8px;
}
.chamado-detalhes .acoes button {
  flex:1;
  padding:10px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  color:#fff;
  cursor:pointer;
  transition: transform 0.2s;
}
.chamado-detalhes .acoes button:hover { transform: scale(1.05); }
.btn-responder { background:#3a1c71; }
.btn-fechar { background:#2ecc71; }
.btn-cancelar { background:#e74c3c; }
.btn-capturar { background:#3498db; color:#fff; }
.btn-capturar:hover { transform: scale(1.05); }

/* Encaminhar container */
#encaminhar-container { display:none; margin-top:10px; flex-direction:column; gap:8px; }
#encaminhar-container select { padding:8px; border-radius:6px; border:1px solid #ccc; }
#confirmar-encaminhar { background:#3a1c71; color:#fff; border:none; padding:8px; border-radius:6px; cursor:pointer; transition: transform 0.2s;}
#confirmar-encaminhar:hover { transform: scale(1.05); }

/* Paginação */
#paginacao { display:flex; justify-content:center; align-items:center; gap:15px; margin-top:auto; }
#paginacao button { padding:8px 12px; border:none; border-radius:6px; background:#6a3ab0; color:#fff; cursor:pointer; transition: transform 0.2s; }
#paginacao button:disabled { opacity:0.5; cursor:default; }
#paginacao button:hover:not(:disabled){ transform:scale(1.05);}
</style>
</head>
<body>
<div class="dashboard">
  <aside class="sidebar">
    <div class="logo">Unitá</div>
    <nav>
      <a href="novoChamado.html">Novo Chamado</a>
    </nav>
    <div class="status-panel" id="status-panel">
      <h3>Status dos Chamados</h3>
      <p>Pendente: <span id="count-pendente">0</span></p>
      <p>Em andamento: <span id="count-em-andamento">0</span></p>
      <p>Concluído: <span id="count-concluido">0</span></p>
      <p>Cancelado: <span id="count-cancelado">0</span></p>
      <p>Tempo médio de conclusão (hrs): <span id="tempo-medio">0</span></p>
    </div>
  </aside>

  <main class="main-content">
    <button id="accordion-filtros">Filtros</button>
    <div class="filtros-panel" id="filtros-panel">
      <input type="number" id="filter-id" placeholder="ID">
      <input type="text" id="filter-setor" placeholder="Setor">
      <input type="text" id="filter-assunto" placeholder="Assunto">
      <input type="text" id="filter-solicitante" placeholder="Solicitante">
      <input type="date" id="filter-data">
      <select id="filter-status">
        <option value="">Todos os status</option>
        <option value="0">Pendente</option>
        <option value="1">Em andamento</option>
        <option value="2">Concluído</option>
        <option value="3">Cancelado</option>
      </select>
    </div>

    <section class="table-section">
      <div class="table-container">
        <table class="chamados-table" id="chamados-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Setor</th>
              <th>Assunto</th>
              <th>Solicitante</th>
              <th>Data</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="6">Carregando chamados...</td></tr>
          </tbody>
        </table>
        <div id="paginacao"></div>
      </div>

      <aside class="chamado-detalhes" id="painel-detalhes">
        <h2>Detalhes do Chamado</h2>
        <div class="info" id="detalhes-info">
          <p>Selecione um chamado para ver detalhes.</p>
        </div>
        <div class="historico">
          <h3>Histórico do Chamado</h3>
          <ul class="historico-chamado" id="detalhes-historico"></ul>
        </div>
        <div class="acoes">
          <button class="btn-capturar" id="btn-capturar">Capturar Chamado</button>
          <button class="btn-responder" id="btn-encaminhar">Encaminhar</button>
          <button class="btn-fechar" id="btn-fechar">Encerrar</button>
          <button class="btn-cancelar" id="btn-cancelar">Cancelar</button>
        </div>

        <div id="encaminhar-container">
          <label for="novo-setor">Escolha o novo setor:</label>
          <select id="novo-setor">
            <option value="">Selecione</option>
            <option value="TI">TI</option>
            <option value="RH">RH</option>
            <option value="Financeiro">Financeiro</option>
            <option value="Comercial">Comercial</option>
          </select>
          <button id="confirmar-encaminhar">Confirmar</button>
        </div>
      </aside>
    </section>
  </main>
</div>

<script>
const API_LISTA = "http://172.20.18.68:5206/api/Chamados";
const API_RELATORIO = "http://172.20.18.68:5206/api/Chamados/Relatorio";
let chamadoSelecionado = null;
let paginaAtual = 1;
const pageSize = 5;
let totalPaginas = 1;
const STATUS_MAP = {0:"Pendente",1:"Em andamento",2:"Concluído",3:"Cancelado"};

// Accordion
document.getElementById("accordion-filtros").addEventListener("click",()=> {
  const acc = document.getElementById("accordion-filtros");
  const panel = document.getElementById("filtros-panel");
  acc.classList.toggle("active");
  panel.style.display = panel.style.display==="flex"?"none":"flex";
});

// Filtros
const filters = ["filter-status","filter-setor","filter-id","filter-assunto","filter-solicitante","filter-data"]
  .map(id=>document.getElementById(id));
filters.forEach(f=>f.addEventListener("input",()=>{ paginaAtual=1; carregarChamados(); }));

// Funções
async function carregarRelatorio(){
  try{
    const token = localStorage.getItem("token");
    const res = await fetch(API_RELATORIO,{ headers:{"Authorization":`Bearer ${token}`,"Content-Type":"application/json"}});
    if(!res.ok) throw new Error("Erro ao buscar relatório");
    const r = await res.json();
    document.getElementById("count-pendente").textContent = r.pendentes;
    document.getElementById("count-em-andamento").textContent = r.emAndamento;
    document.getElementById("count-concluido").textContent = r.concluido;
    document.getElementById("count-cancelado").textContent = r.cancelado;
    document.getElementById("tempo-medio").textContent = r.tempoMedioConclusaoHoras;
  }catch(err){ console.error(err);}
}

async function atualizarChamado(id,statusEnum,setorResponsavel){
  try{
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_LISTA}/${id}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},
      body: JSON.stringify({id,statusEnum,setorResponsavel})
    });
    return res.ok;
  }catch(err){ console.error(err); return false;}
}

function limparDetalhes(){
  chamadoSelecionado=null;
  document.getElementById("detalhes-info").innerHTML=`<p>Selecione um chamado para ver detalhes.</p>`;
  document.getElementById("detalhes-historico").innerHTML=``;
  document.getElementById("encaminhar-container").style.display="none";
}

async function mostrarDetalhes(id){
  try{
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_LISTA}/${id}`,{ headers:{"Authorization":`Bearer ${token}`}});
    if(!res.ok) throw new Error("Erro ao buscar detalhes");
    let c = await res.json();
    chamadoSelecionado = c;

    const statusTexto = STATUS_MAP[c.status] || c.status;
    document.getElementById("detalhes-info").innerHTML = `
      <p><strong>Título:</strong> ${c.titulo}</p>
      <p><strong>Descrição:</strong> ${c.descricao||"Sem descrição"}</p>
      <p><strong>Setor:</strong> ${c.setorResponsavel}</p>
      <p><strong>Status:</strong> ${statusTexto}</p>
    `;
    document.getElementById("detalhes-historico").innerHTML = `
      <li>Chamado criado em ${new Date(c.dataCriacao||c.data).toLocaleString()}</li>
      <li>Status atual: <strong>${STATUS_MAP[c.status]}</strong></li>
    `;
    carregarChamados();
  }catch(err){ console.error(err); alert("Erro ao buscar detalhes do chamado"); }
}

async function carregarChamados(){
  try{
    const token = localStorage.getItem("token");
    const params = new URLSearchParams();
    if(document.getElementById("filter-status").value) params.append("status", document.getElementById("filter-status").value);
    if(document.getElementById("filter-setor").value) params.append("setor", document.getElementById("filter-setor").value);
    if(document.getElementById("filter-id").value) params.append("search", document.getElementById("filter-id").value);
    if(document.getElementById("filter-assunto").value) params.append("search", document.getElementById("filter-assunto").value);
    if(document.getElementById("filter-solicitante").value) params.append("solicitante", document.getElementById("filter-solicitante").value);
    if(document.getElementById("filter-data").value) params.append("de", document.getElementById("filter-data").value);
    params.append("page",paginaAtual);
    params.append("pageSize",pageSize);

    const res = await fetch(`${API_LISTA}?${params.toString()}`,{ headers:{"Authorization":`Bearer ${token}`}});
    if(!res.ok) throw new Error("Erro ao buscar chamados");
    const data = await res.json();
    totalPaginas = data.totalPages;

    const tbody = document.getElementById("table-body");
    tbody.innerHTML="";
    if(data.items.length===0){
      tbody.innerHTML=`<tr><td colspan="6">Nenhum chamado encontrado</td></tr>`;
    }else{
      data.items.forEach(c=>{
        const tr = document.createElement("tr");
        const statusTexto = STATUS_MAP[c.status]||c.status;
        tr.innerHTML=`
          <td>${c.id}</td>
          <td>${c.setorResponsavel}</td>
          <td>${c.titulo}</td>
          <td>${c.solicitante||"-"}</td>
          <td>${new Date(c.dataCriacao||c.data).toLocaleDateString()}</td>
          <td class="status ${statusTexto.toLowerCase().replace(' ','-')}">${statusTexto}</td>
        `;
        tr.addEventListener("click",()=>mostrarDetalhes(c.id));
        tbody.appendChild(tr);
      });
    }
    carregarRelatorio();
    atualizarControlesPaginacao();
  }catch(err){ console.error(err); document.getElementById("table-body").innerHTML=`<tr><td colspan="6">Erro ao carregar chamados</td></tr>`;}
}

function atualizarControlesPaginacao(){
  let pagDiv = document.getElementById("paginacao");
  pagDiv.innerHTML = `
    <button ${paginaAtual===1?'disabled':''} onclick="paginaAtual--; carregarChamados();">Anterior</button>
    <span>Página ${paginaAtual} de ${totalPaginas}</span>
    <button ${paginaAtual===totalPaginas?'disabled':''} onclick="paginaAtual++; carregarChamados();">Próxima</button>
  `;
}

// Botões de ação
document.getElementById("btn-capturar").addEventListener("click", async()=>{
  if(!chamadoSelecionado){ alert("Selecione um chamado primeiro!"); return; }
  if(chamadoSelecionado.status === 1){ alert("Chamado já está em andamento."); return; }
  const sucesso = await atualizarChamado(chamadoSelecionado.id, 1, chamadoSelecionado.setorResponsavel);
  if(sucesso){
    alert("Chamado capturado e agora está em andamento!");
    mostrarDetalhes(chamadoSelecionado.id);
    carregarChamados();
  } else {
    alert("Erro ao capturar chamado.");
  }
});

document.getElementById("btn-encaminhar").addEventListener("click",()=>{ 
  if(!chamadoSelecionado){ alert("Selecione um chamado primeiro!"); return; } 
  document.getElementById("encaminhar-container").style.display="flex"; 
});

document.getElementById("confirmar-encaminhar").addEventListener("click",async()=>{
  const novoSetor = document.getElementById("novo-setor").value;
  if(!novoSetor){ alert("Selecione um setor válido."); return; }
  const sucesso = await atualizarChamado(chamadoSelecionado.id,0,novoSetor);
  if(sucesso){ alert("Chamado encaminhado!"); limparDetalhes(); carregarChamados();}
  else alert("Erro ao encaminhar chamado.");
});

document.getElementById("btn-fechar").addEventListener("click",async()=>{
  if(!chamadoSelecionado){ alert("Selecione um chamado primeiro!"); return; } 
  if(confirm("Deseja realmente encerrar este chamado?")){
    const sucesso = await atualizarChamado(chamadoSelecionado.id,2,chamadoSelecionado.setorResponsavel);
    if(sucesso){ alert("Chamado encerrado!"); limparDetalhes(); carregarChamados();}
    else alert("Erro ao encerrar chamado.");
  }
});

document.getElementById("btn-cancelar").addEventListener("click",async()=>{
  if(!chamadoSelecionado){ alert("Selecione um chamado primeiro!"); return; } 
  if(confirm("Deseja realmente cancelar este chamado?")){
    const sucesso = await atualizarChamado(chamadoSelecionado.id,3,chamadoSelecionado.setorResponsavel);
    if(sucesso){ alert("Chamado cancelado!"); limparDetalhes(); carregarChamados();}
    else alert("Erro ao cancelar chamado.");
  }
});

// Inicialização
window.addEventListener("load",()=>{ carregarChamados(); carregarRelatorio(); });
</script>
</body>
</html>